---
title: "Redis进阶知识04-主从复制原理"
subtitle: ""
layout: post
author: "Geooo"
header-img: ""
header-style: text
tags:
  - Redis
  
---



# Redis的主从库模式



之所以Redis具有高可靠性，是因为Redis保证了

- 1.**数据尽量少丢失**（AOF和RDB保证了该点）
- 2.**服务尽量少中断**（Redis的做法是增大副本冗余量 --- 即将一份数据同时保存在多个实例上）



## 主从间的"读写分离"

Redis提供了 **主从库模式** ，以保证数据副本的一致，主从库之间采用 **''读写分离"** 的方式。

- **读操作**：主库 和 从库都可以接收。
- **写操作**：首先主库接收执行，然后由主库同步到从库

![](https://static001.geekbang.org/resource/image/80/2f/809d6707404731f7e493b832aa573a2f.jpg)



### 为什么采用“主从分离”？

  如果在上图中，不管是主库还是从库，都能接收客户端的写操作，那么，一个直接的问题就是：如果客户端对同一个数据（例如 k1）前后修改了三次，每一次的修改请求都发送到不同的实例上，在不同的实例上执行，那么，这个数据在这三个实例上的副本就不一致了（分别是 v1、v2 和 v3）。

  如果我们非要保持这个数据在三个实例上一致，就要涉及到加锁、实例间协商是否完成修改等一系列操作，但这会带来巨额的开销，当然是不太能接受的。

  而主从库模式一旦采用了读写分离，所有数据的修改**只会在主库上进行**，不用协调三个实例。主库有了最新的数据后，会**同步**给从库，这样，主从库的数据就是一致的。



## 主从库同步是如何实现的？

当我们启动多个 Redis 实例的时候，它们相互之间就可以通过 replicaof（Redis 5.0 之前使用 slaveof）命令形成主库和从库的关系。

主从库数据同步分为 **三个阶段, (如下图)**。

![](https://static001.geekbang.org/resource/image/63/a1/63d18fd41efc9635e7e9105ce1c33da1.jpg)



### 第一阶段

第一阶段是主从库间建立连接、协商同步的过程，主要是为全量复制做准备。在这一步，**从库和主库建立起连接，并告诉主库即将进行同步，主库确认回复后，主从库间就可以开始同步了。**



具体来说，从库给主库发送 psync 命令，表示要进行数据同步，主库根据这个命令的参数来启动复制。psync 命令包含了主库的 **runID **和 **复制进度offset** 两个参数。

- **runID**，是每个 Redis 实例启动时都会自动生成的一个随机 ID，用来唯一标记这个实例。当从库和主库第一次复制时，因为不知道主库的 runID，所以将 runID 设为“？”。
- offset，表示复制的进度，此时设为-1，表示第一次复制

